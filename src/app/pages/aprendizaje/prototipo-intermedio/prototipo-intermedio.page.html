<ion-header class="ion-no-border">
  <ion-toolbar class="navbar">
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        class="nav-back-btn"
        (click)="irAComponentes()"
        title="Volver a Componentes"
        aria-label="Volver a Componentes">
        <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
        Volver atras
      </ion-button>
    </ion-buttons>

    <ion-title>Ensamble Intermedio</ion-title>
    <ion-buttons slot="end">
      <ion-badge color="tertiary" mode="ios">
        {{ pasoActual + 1 }} / {{ pasos.length }}
      </ion-badge>
    </ion-buttons>
  </ion-toolbar>
  <ion-progress-bar [value]="(pasoActual + 1) / pasos.length" color="tertiary"></ion-progress-bar>

</ion-header>

<ion-content>
  
  <div class="split-layout">

    <div class="left-panel">
      <div class="visor-container">
        <div #threeContainer class="three-canvas"></div>
        <div class="visor-badge">
          <ion-icon name="cube-outline"></ion-icon> Visualización 3D
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="manual-card-content">
        
        <div class="step-info">
          <div class="tech-header">
            <ion-badge [color]="pasos[pasoActual].color" class="step-category">
              Fase {{ pasos[pasoActual].fase }}
            </ion-badge>
            <span class="step-tech-id">ID: {{ pasoActual + 101 }}</span>
          </div>
          
          <h2 class="step-title">{{ pasos[pasoActual].titulo }}</h2>
          
          <p class="step-desc">
            {{ pasos[pasoActual].descripcion }}
          </p>

          <div class="tech-specs" *ngIf="pasos[pasoActual].detalleTecnico">
            <strong>Especificación:</strong> {{ pasos[pasoActual].detalleTecnico }}
          </div>

          <div class="step-note" *ngIf="pasos[pasoActual].nota">
            <ion-icon name="warning-outline" slot="start"></ion-icon>
            <span>{{ pasos[pasoActual].nota }}</span>
          </div>
        </div>

        <div class="navigation-buttons">
          
          <ion-button
            fill="outline"
            color="dark"
            (click)="cambiarPaso(-1)"
            [disabled]="pasoActual === 0"
            title="Atrás"
            aria-label="Atrás">
            <img src="assets/icon/flecha.png" width="22" height="22" alt="Atrás" />
          </ion-button>

          <ion-button
            *ngIf="pasoActual < pasos.length - 1"
            expand="block" 
            class="flex-grow" 
            color="tertiary"
            (click)="cambiarPaso(1)">
            
            <span>Siguiente Instrucción</span>
            <ion-icon slot="end" name="arrow-forward"></ion-icon>
          
          </ion-button>

          <ion-button
            *ngIf="pasoActual === pasos.length - 1"
            expand="block"
            class="flex-grow finish-toggle"
            color="success"
            (click)="toggleEvaluacion()"
            [attr.aria-expanded]="evaluacionAbierta"
            aria-controls="evaluacionPanel">

            <span>{{ evaluacionAbierta ? 'Ocultar test' : 'Resolver test' }}</span>
            <ion-icon
              slot="end"
              [name]="evaluacionAbierta ? 'chevron-up' : 'chevron-down'">
            </ion-icon>

          </ion-button>

        </div>

        <div
          id="evaluacionPanel"
          class="evaluacion-panel"
          *ngIf="pasoActual === pasos.length - 1 && evaluacionAbierta">

          <div class="evaluacion-head">
            <ion-icon class="evaluacion-icon" name="clipboard-outline"></ion-icon>

            <div class="evaluacion-text">
              <h3 class="evaluacion-title">Test de Ensamble Intermedio</h3>
              <p class="evaluacion-subtitle">
                Resuelve el formulario para comprobar lo aprendido. Si no carga aquí, ábrelo en una nueva pestaña.
              </p>
            </div>
          </div>

          <div class="evaluacion-actions">
            <ion-button
              class="action-button"
              color="success"
              expand="block"
              [href]="googleFormUrl"
              target="_blank"
              rel="noopener noreferrer">
              Abrir en Google Forms
              <ion-icon slot="end" name="open-outline"></ion-icon>
            </ion-button>

            <ion-button
              class="action-button"
              fill="outline"
              color="dark"
              expand="block"
              (click)="irAComponentes()">
              Ir a Componentes
              <ion-icon slot="end" name="list-outline"></ion-icon>
            </ion-button>
          </div>

          <div class="form-embed" role="region" aria-label="Formulario de evaluación">
            <iframe
              src="https://docs.google.com/forms/d/e/1FAIpQLSfZUehitLbFa_V2i-MfSquqOxTOU-GThvnVnVCVJFhqBAXUaA/viewform?embedded=true"
              title="Test de Ensamble Intermedio"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
          </div>

        </div>

      </div>
    </div>

  </div>

</ion-content>
