<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        class="nav-back-btn"
        (click)="irAComponentes()"
        title="Volver a Componentes"
        aria-label="Volver a Componentes">
        <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
        Volver atras
      </ion-button>
    </ion-buttons>

    <ion-title>Master Build</ion-title>

    <ion-buttons slot="end">
        <ion-badge class="step-badge" mode="ios">
          {{ pasoActual + 1 }} / {{ pasos.length }}
        </ion-badge>
    </ion-buttons>
  </ion-toolbar>

  <ion-progress-bar
    [value]="(pasoActual + 1) / pasos.length"
    class="custom-progress">
  </ion-progress-bar>
</ion-header>

<ion-content>
  <div class="split-layout">
    <div class="left-panel">
      <div class="visor-container">
        <div #threeContainer class="three-canvas"></div>
        <div class="visor-badge">
          <ion-icon name="water-outline"></ion-icon>
          Refrigeración Líquida
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="manual-card-content">

        <div class="step-info">
          <div class="header-row">
            <ion-badge color="dark" class="phase-badge">
              FASE {{ pasos[pasoActual].fase }}
            </ion-badge>
            <span class="tech-id">ID: {{ pasoActual + 300 }}</span>
          </div>

          <h2 class="step-title">{{ pasos[pasoActual].titulo }}</h2>

          <p class="step-desc">
            {{ pasos[pasoActual].descripcion }}
          </p>

          <div class="specs-box">
            <div class="spec-row">
              <span class="label">Herramienta:</span>
              <span class="value">{{ pasos[pasoActual].herramienta }}</span>
            </div>
            <div class="spec-row">
              <span class="label">Precaución:</span>
              <span class="value text-warning">{{ pasos[pasoActual].riesgo }}</span>
            </div>
          </div>

          <div class="pro-tip" *ngIf="pasos[pasoActual].tip">
            <div class="tip-text">
              <strong>Tip Experto:</strong> {{ pasos[pasoActual].tip }}
            </div>
          </div>
        </div>

        <div class="navigation-buttons">
          <ion-button
            fill="outline"
            color="medium"
            (click)="cambiarPaso(-1)"
            [disabled]="pasoActual === 0"
            title="Atrás"
            aria-label="Atrás">
            <img src="assets/icon/flecha.png" width="22" height="22" alt="Atrás" />
          </ion-button>

          <ion-button
            *ngIf="pasoActual < pasos.length - 1"
            expand="block"
            class="flex-grow action-btn"
            (click)="cambiarPaso(1)">
            <span>Siguiente Paso</span>
            <ion-icon slot="end" name="arrow-forward"></ion-icon>
          </ion-button>

          <ion-button
            *ngIf="pasoActual === pasos.length - 1"
            expand="block"
            class="flex-grow finish-toggle"
            color="success"
            (click)="toggleEvaluacion()"
            [attr.aria-expanded]="evaluacionAbierta"
            aria-controls="evaluacionPanel">
            <span>{{ evaluacionAbierta ? 'Ocultar test' : 'Resolver test' }}</span>
            <ion-icon
              slot="end"
              [name]="evaluacionAbierta ? 'chevron-up' : 'chevron-down'">
            </ion-icon>
          </ion-button>
        </div>

        <div
          id="evaluacionPanel"
          class="evaluacion-panel"
          *ngIf="pasoActual === pasos.length - 1 && evaluacionAbierta">

          <div class="evaluacion-head">
            <ion-icon class="evaluacion-icon" name="clipboard-outline"></ion-icon>

            <div class="evaluacion-text">
              <h3 class="evaluacion-title">Test de Master Build</h3>
              <p class="evaluacion-subtitle">
                Resuelve el formulario para comprobar lo aprendido. Si no carga aquí, ábrelo en una nueva pestaña.
              </p>
            </div>
          </div>

          <div class="evaluacion-actions">
            <ion-button
              class="action-button"
              color="success"
              expand="block"
              [href]="googleFormUrl"
              target="_blank"
              rel="noopener noreferrer">
              Abrir en Google Forms
              <ion-icon slot="end" name="open-outline"></ion-icon>
            </ion-button>

            <ion-button
              class="action-button"
              fill="outline"
              color="dark"
              expand="block"
              (click)="irAComponentes()">
              Ir a Componentes
              <ion-icon slot="end" name="list-outline"></ion-icon>
            </ion-button>
          </div>

          <div class="form-embed" role="region" aria-label="Formulario de evaluación">
            <iframe
              src="https://docs.google.com/forms/d/e/1FAIpQLSfjGF2LfAZTBe90IpXU-Uh3XZRURw8ms5447cmtbqrKksBfWA/viewform?embedded=true"
              title="Test de Master Build"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
          </div>

        </div>

      </div>
    </div>
  </div>
</ion-content>
